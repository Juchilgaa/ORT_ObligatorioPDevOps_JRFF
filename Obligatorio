import boto3

ec2 = boto3.client('ec2')

# Parámetro por defecto
image_id = 'ami-06b21ccaeff8cd686'
response = ec2.run_instances(
    ImageId=image_id,
    MinCount=1,
    MaxCount=1,
    InstanceType='t2.micro'
)
instance_id = response['Instances'][0]['InstanceId']
print(f"Instancia creada con ID: {instance_id}")



ec2 = boto3.client('ec2')

user_data = '''#!/bin/bash
yum update -y
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "¡Sitio personalizado!" > /var/www/html/index.html
'''

response = ec2.run_instances(
    ImageId='ami-06b21ccaeff8cd686',
    InstanceType='t2.micro',
    MinCount=1,
    MaxCount=1,
    IamInstanceProfile={'Name': 'LabInstanceProfile'},
    UserData=user_data
)

# Agregar tag Name: webserver-devops
instance_id = response['Instances'][0]['InstanceId']
ec2.create_tags(
    Resources=[instance_id],
    Tags=[{'Key': 'Name', 'Value': 'webserver-devops'}]
)
print(f"Instancia creada con ID: {instance_id} y tag 'webserver-devops'")


#Instalación Apache (httpd) + PHP-FPM
# 1) Actualiza índices y paquetes
#sudo dnf clean all
#sudo dnf makecache
#sudo dnf -y update

# 2) Instala Apache + PHP 8.4 + mariadb y extensiones típicas
#sudo dnf -y install httpd php php-cli php-fpm php-common php-mysqlnd mariadb105

# 3) Habilita y arranca servicios
#sudo systemctl enable --now httpd
#sudo systemctl enable --now php-fpm

# 4) Asegura que Apache pase .php a PHP-FPM
# En AL2023 normalmente se instala /etc/httpd/conf.d/php-fpm.conf con esto,
# pero si no existiera:
#echo '<FilesMatch \.php$>
#  SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost/"
#</FilesMatch>' | sudo tee /etc/httpd/conf.d/php-fpm.conf

# 5) Archivo de prueba
#echo "<?php phpinfo(); ?>" | sudo tee /var/www/html/info.php

# 6) Reinicia para tomar config
#sudo systemctl restart httpd php-fpm

